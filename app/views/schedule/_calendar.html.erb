<div class="calendar bg-white dark:bg-gray-800 shadow-sm rounded-md p-4 mb-4">
  <!-- Calendar Legend and Navigation -->
  <div class="mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
    <div class="flex items-center justify-between">
      <!-- Calendar Legend -->
      <div class="flex flex-wrap items-center gap-4 text-xs text-gray-600 dark:text-gray-400">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full bg-red-300 dark:bg-red-500"></div>
          <span>Selected & Today</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full bg-indigo-100 dark:bg-indigo-400"></div>
          <span>Selected Date</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full ring-2 ring-red-300 dark:ring-red-500 bg-white dark:bg-gray-800"></div>
          <span>Today</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded-full <%= theme_bg %>"></div>
          <span>Has Tasks</span>
        </div>
      </div>

      <!-- Navigation Buttons -->
      <div class="flex items-center gap-2">
        <%= link_to schedule_path(date: @date.prev_month), class: "border rounded-full dark:border-gray-600 prev-month flex items-center justify-center p-2 text-gray-400 hover:text-gray-500" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        <% end %>
        <%= link_to schedule_path(date: @date.next_month), class: "border rounded-full dark:border-gray-600 next-month flex items-center justify-center p-2 text-gray-400 hover:text-gray-500" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Three Month Layout - Vertical Stack -->
  <div class="space-y-0">
    <!-- Current Month -->
    <div class="grid grid-cols-1 md:grid-cols-[300px_1fr] gap-6 pb-6 border-b border-gray-200 dark:border-gray-700">
      <div class="calendar-month">
        <%= render_calendar_month(@date, @daily_task_counts, params[:date]) %>
      </div>

      <!-- Current Month Tasks -->
      <div class="tasks-list">
        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">Tasks</h4>
        <% current_month_tasks = @monthly_tasks.select { |task| task.due_date&.month == @date.month } %>
        <% if current_month_tasks.any? %>
          <div class="space-y-1">
            <% current_month_tasks.each do |task| %>
              <%= render 'schedule/task', task: task %>
            <% end %>
          </div>
        <% else %>
          <p class="text-xs text-gray-400 dark:text-gray-500">No tasks scheduled</p>
        <% end %>
      </div>
    </div>

    <!-- Next Month -->
    <div class="grid grid-cols-1 md:grid-cols-[300px_1fr] gap-6 py-6 border-b border-gray-200 dark:border-gray-700">
      <div class="calendar-month">
        <%= render_calendar_month(@date.next_month, @daily_task_counts, params[:date]) %>
      </div>

      <!-- Next Month Tasks -->
      <div class="tasks-list">
        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">Tasks</h4>
        <% next_month_tasks = @monthly_tasks.select { |task| task.due_date&.month == @date.next_month.month } %>
        <% if next_month_tasks.any? %>
          <div class="space-y-1">
            <% next_month_tasks.each do |task| %>
              <%= render 'schedule/task', task: task %>
            <% end %>
          </div>
        <% else %>
          <p class="text-xs text-gray-400 dark:text-gray-500">No tasks scheduled</p>
        <% end %>
      </div>
    </div>

    <!-- Month After Next -->
    <div class="grid grid-cols-1 md:grid-cols-[300px_1fr] gap-6 pt-6">
      <div class="calendar-month">
        <%= render_calendar_month(@date.next_month.next_month, @daily_task_counts, params[:date]) %>
      </div>

      <!-- Month After Next Tasks -->
      <div class="tasks-list">
        <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-3">Tasks</h4>
        <% month_after_next_tasks = @monthly_tasks.select { |task| task.due_date&.month == @date.next_month.next_month.month } %>
        <% if month_after_next_tasks.any? %>
          <div class="space-y-1">
            <% month_after_next_tasks.each do |task| %>
              <%= render 'schedule/task', task: task %>
            <% end %>
          </div>
        <% else %>
          <p class="text-xs text-gray-400 dark:text-gray-500">No tasks scheduled</p>
        <% end %>
      </div>
    </div>
  </div>
</div>
